---
title: 嵌入式代码开发规范
date: 2020-02-05 18:35:19
tags: 
- C语言
- STM32
categories:
- 嵌入式
---
这是一个嵌入式开发的代码规范文档  
为了在写代码时有据可循而不是凭印象来编写，故输出文档形式
在编写期间参考了 Linux内核，谷歌和Bataflight等代码规范和git,cmockery,micropython,ametal,bataflight等工程代码
<!-- more -->
## 缩进  

1 tab表示四个空格  

除了注释、文档和 Kconfig 之外，不要使用空格来缩进

## 把长的行和字符串打散

代码风格的意义就在于用平常使用的工具来维持代码的可读性和可维护性。

每一行的长度的限制是 120 列，长于 120 列的语句要打散成有意义的片段。因为 120 列便于在GitHub上查看，除非超过 120 列能显著增加可读性并且不会隐藏信息。  

子片段要明显短于母片段，并明显靠右。这同样适用于有着很长参数列表的函数头。  

绝对不要打散对用户可见的字符串，例如 printk 信息，因为这样就很难对它们 grep。  

``` C
static int parse_bundle_header(int fd, struct bundle_header *header,
			                    const char *report_path)
{
	struct strbuf buf = STRBUF_INIT;
	int status = 0;

	/* The bundle header begins with the signature */
	if (strbuf_getwholeline_fd(&buf, fd, '\n') ||
	    strcmp(buf.buf, bundle_signature)) {
		if (report_path) {
			error(_("'%s' does not look like a v2 bundle file"),
			      report_path);
        }
	}
}
```
## 大括号的放置  

起始大括号放在行尾，结束大括号放在行首,所以：  

```C
if (x is true) {
    we do y
}
```

这适用于所有的非函数语句块 (if, switch, for, while, do)。比如：  

``` C
if (x == y) {
    we do x
} else if (x > y) {
    we do y
} else {
    we do z
}
```
* 无论 if 和 else 后面是不是单个语句， **{} 都不可省略**

``` C
switch (action) {
case ADD:
    return "add";
case REMOVE:
    return "remove";
case CHANGE:
    return "change";
default:
    return NULL;
}
```
``` C
for (int i = 0; i <= 10; i ++) {
    we do y
}
```
``` C
do {
    body of do-loop
} while (condition);
```
不过，有一个例外，那就是函数：函数的起始大括号放置于下一行的开头，所以：
  
``` C
int function(int x)
{
    body of function
}
```

## 空格的放置  
* 空格的使用方式主要取决于它是用于函数还是关键字。(大多数) 关键字后要加一个空格。值得注意的例外是 sizeof, typeof, alignof 和 __attribute__，这    些关键字某些程度上看起来更像函数 (它们也常常伴随小括号而使用，尽管在 C 里这样的小括号不是必需的，就像 struct fileinfo info; 声明过后的 sizeof info)。
所以在这些关键字之后放一个空格:  
``` c
if, switch, case, for, do, while
```
但是不要在 sizeof, typeof, alignof 或者 __attribute__ 这些关键字之后放空格。 例如，  
``` C 
s = sizeof(struct file);
```
* 不要在小括号里的表达式两侧加空格。  

* 当声明指针类型或者返回指针类型的函数时， * 的首选使用方式是使之靠近变量名或者函数名，而不是靠近类型名。例如：  
``` c
char *linux_banner;
unsigned long long memparse(char *ptr, char **retptr);
char *match_strdup(substring_t *s);
```
* 大多数二元和三元操作符两侧使用一个空格，例如下面所有这些操作符:  
``` C
=  +  -  <  >  *  /  %  |  &  ^  <=  >=  ==  !=  ?  :  
```
* 但是一元操作符后不要加空格:
``` C
&  *  +  -  ~  !  sizeof  typeof  alignof  __attribute__  defined
```
* 前缀自加和自减和后缀自加和自减一元操作符前不加空格:
``` C
++  --
```
* . 和 -> 结构体成员操作符前后不加空格。  
* & 和 *  作为指针和引用时与变量之间不加空格。  
* 行尾或空白行中没有尾随空格。  

## typedef
* 最后一个元素后带有逗号，使在审阅时只显示添加的部分 
``` C
typedef enum {
    MSP_RESULT_ACK = 1,
    MSP_RESULT_ERROR = -1,
    MSP_RESULT_NO_REPLY = 0,
    MSP_RESULT_CMD_UNKNOWN = -2,
} msp_result_e;
```
* 结构体名称motor_mixer_s不可省略，以便作为前置引用  
``` C
typedef struct motor_mixer_s {
    float throttle;
...
    float yaw;
} motor_mixer_t;
```

## 变量  

* 变量使用小写字母加 _ 的方式命名，不使用大小写混合方式。(但是当使用官方库或者第三方程序时，代码风格和他们保持一致) ,变量应该是简短且有意义的名词。  
``` C 
uint8_t lptim1_count_overflow;
uint32_t lptim1_count_value;  
```

* C 程序员不使用类似ThisVariableIsATemporaryCounter 这样华丽的名字。C 程序员会称那个变量为 tmp    
* 本地变量名应该简短，而且能够表达相关的含义。如果你有一些随机的整数型的循环计数器，它应该被称为 i 。叫它 loop_counter 并无益处  
* 同样称一个全局函数为 foo（无意义的名字） 是一个难以饶恕的错误。
* 避免使用全局变量(只有当你 * 真正 * 需要它们的时候再用它)，变量应该在最小作用区域前声明,必要时可增加 {} 进一步限制范围  

``` C 
 for (int i = 0; i < 4; i++)
```

* 当不同的变量的使用无关时，声明后应留一个空白行。

* 不要依赖隐式转换。  

* 浮点常量应使用“ f”后缀定义，例如1.0f和3.1415926f，否则可能会发生双重转换。

## 函数  
### 命名  

* 函数使用小写字母加 _ 的方式命名，名称包含 动词 + 名词 ，如delete_page,告诉系统“用”某物“做”某事。非静态函数应该以他们的类名或者文件名作为前缀  
``` C 
void power_clock_init(void);
void power_enter_stop(void);
void power_enter_run(void);
void power_enter_lprun(void);
```

### 参数规则  

* 数据应从右向左移动，如 memcpy（void * dst，const void * src，size_t size）。
这也模仿了赋值运算符（例如dst = src;），即输出参数在前，输入参数在后，且所有按引用传递的参数必须加上 const

### 声明  
* 在其包含的.c文件之外未使用的函数应声明为静态。 
* 非静态函数应在单个.h文件中声明它们，可在函数前加相同的前缀，利于分辨功能作用对象  
使用
``` C 
#ifdef MODULENAME_INTERNALS_
… declarations …
#endif
```
来保证只包含必要的内容  

## 执行  
* 切勿将多条语句放在一行上。  

* 函数应该简短而漂亮，并且只完成一件事情。函数应该可以一屏或者两屏显示完(120*24)，只做一件事情，而且把它做好。

* 一个函数的最大长度是和该函数的复杂度和缩进级数成反比的。所以，如果你有一个理论上很简单的只有一个很长 (但是简单) 的 case 语句的函数，而且你需要在每个 case 里做很多很小的事情，这样的函数尽管很长，但也是可以的。  

* 函数的另外一个衡量标准是本地变量的数量。此数量不应超过 5－10 个，否则你的函数就有问题了。重新考虑一下你的函数，把它分拆成更小的函数。人的大脑一般可以轻松的同时跟踪 7 个不同的事物，如果再增多的话，就会糊涂了。即便你聪颖过人，你也可能会记不清你 2 个星期前做过的事情  

* 一个函数在每个调用中应该只从硬件读取一次数据，最好一次在一个地方读取一次。
例如，如果多次需要陀螺仪角度或时间，则读取一次并存储在局部变量中

* 在表达式中，仅应在需要括号的地方使用括号，即运算符优先级的计算顺序不正确，或在没有括号的情况下触发编译器警告的地方。这使所有表达式都变成规范形式，避免了不同开发人员对什么是“易于阅读”表达式有不同想法的问题。  
对于三元运算符例外  
``` C 
result = (a == b) ? true : false  
```
条件应用大括号括起来，以使三元运算符在从左到右阅读时更容易发现。  

## include  

* 所有文件都必须包含自己的依赖项，而不是通过自己依赖项来包含依赖项  
* 不要包括不使用的东西  
使用
``` C  
#ifndef  
#define  

#endif
```
或者  
``` C  
"#pragma once"
```
来避免重复包含  

## 其他细节

* 行尾或空行中没有尾随空格。  

* 文件名要全部小写，可以包含下划线 _ ,名字应该具有描述性，避免使用缩写。  
每一个 .c 文件都要有一个对应的 .h 文件   

* 充分利用编译时检查的优势，因此警告应尽可能严格检查   

* 不要调用或者向上引用。也就是说在当前层不要调用任何当前层之上的东西    

* 代码公共接口应该少且易于使用，做一些必不可少的事情，并且所有不重要的实现都应该对用户隐藏。

       